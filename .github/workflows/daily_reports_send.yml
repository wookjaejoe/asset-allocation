name: daily-reports-send

on:
  workflow_dispatch:
    inputs:
      mail_to:
        description: "이메일 수신자 (비워두면 vars.MAIL_TO 사용)"
        required: false
        default: ""
        type: string
  schedule:
    # 08:00 KST = 23:00 UTC (previous day)
    - cron: "0 23 * * 0"

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Check odd week (KST) or manual run
        id: weekcheck
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          WEEK="$(TZ=Asia/Seoul date +%V)"
          if ((10#$WEEK % 2 == 1)); then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.weekcheck.outputs.run == 'true'

      - uses: actions/setup-python@v5
        if: steps.weekcheck.outputs.run == 'true'
        with:
          python-version: "3.11"

      - name: Find latest generate run
        if: steps.weekcheck.outputs.run == 'true'
        id: find_run
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          RUN_JSON=$(gh run list \
            --workflow daily_reports_generate.yml \
            --status completed \
            --limit 1 \
            --json databaseId,conclusion)
          RUN_ID=$(python - <<'PY' <<<"$RUN_JSON"
            import json, sys
            runs = json.loads(sys.stdin.read() or "[]")
            if runs:
                print(runs[0].get("databaseId", ""))
          PY
          )
          CONCLUSION=$(python - <<'PY' <<<"$RUN_JSON"
            import json, sys
            runs = json.loads(sys.stdin.read() or "[]")
            if runs:
                print(runs[0].get("conclusion", ""))
          PY
          )
          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "conclusion=${CONCLUSION}" >> "$GITHUB_OUTPUT"

      - name: Download latest artifact
        if: steps.weekcheck.outputs.run == 'true' && steps.find_run.outputs.conclusion == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          gh run download "${{ steps.find_run.outputs.run_id }}" \
            -n daily-reports-output \
            -D .

      - name: Send email (success or failure)
        if: steps.weekcheck.outputs.run == 'true'
        shell: bash
        env:
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USER: ${{ vars.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_STARTTLS: ${{ vars.SMTP_STARTTLS }}
          MAIL_FROM: ${{ vars.MAIL_FROM }}
          MAIL_TO_INPUT: ${{ inputs.mail_to }}
          MAIL_TO_DEFAULT: ${{ vars.MAIL_TO }}
        run: |
          MAIL_TO="${MAIL_TO_INPUT:-$MAIL_TO_DEFAULT}"
          if [[ -z "${SMTP_HOST}" || -z "${MAIL_FROM}" || -z "${MAIL_TO}" || -z "${SMTP_PASS}" ]]; then
            echo "SMTP vars/secrets not configured; skipping send."
            exit 0
          fi

          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          EMAIL_HTML=".output/daily_reports/${TODAY_KST}/email.html"

          if [[ "${{ steps.find_run.outputs.conclusion }}" == "success" && -f "${EMAIL_HTML}" ]]; then
            SUBJECT="[Daily] Reports (${TODAY_KST} 08:00 KST)"
            python scripts/send_email_smtp.py \
              --subject "${SUBJECT}" \
              --html "${EMAIL_HTML}" \
              --to "${MAIL_TO}" \
              --attach ".output/rank_analysis.html" \
              --attach ".output/aa_analysis.html"
            exit 0
          fi

          mkdir -p .output
          FAIL_HTML=".output/daily_reports_failure_${TODAY_KST}.html"
          cat > "${FAIL_HTML}" <<HTML
          <html>
            <body>
              <h2>Daily report generation failed</h2>
              <p>The scheduled report for ${TODAY_KST} (KST) did not complete successfully.</p>
              <p>Please contact the administrator to investigate the workflow run.</p>
            </body>
          </html>
          HTML

          SUBJECT="[Daily] Reports FAILED (${TODAY_KST} 08:00 KST)"
          python scripts/send_email_smtp.py \
            --subject "${SUBJECT}" \
            --html "${FAIL_HTML}" \
            --to "${MAIL_TO}"
