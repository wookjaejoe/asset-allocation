name: daily-reports-email

on:
  workflow_dispatch: {}
  # NOTE: Enable this schedule only if you disable the two separate daily workflows,
  # otherwise you'll send duplicate emails.
  # schedule:
  #   # 08:00 KST = 23:00 UTC (previous day)
  #   - cron: "0 23 * * *"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      # Backtest parameters (reduced set for daily runs)
      HEAD_LOOKBACKS_CSV: "250,120,60"
      TAIL_LOOKBACKS_CSV: "40,20,10"
      TOPS_CSV: "50"
      REBAL_MONTHS_CSV: "1,3,6"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache price data
        uses: actions/cache@v4
        with:
          path: .cache
          key: price-cache-${{ runner.os }}-${{ hashFiles('requirements-actions.txt') }}
          restore-keys: |
            price-cache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-actions.txt

      - name: Generate daily signals + email bodies
        run: |
          python scripts/daily_asset_allocation_report.py
          python scripts/daily_rank_report.py \
            --top 20 \
            --head-lookbacks "120,252" \
            --tail-lookbacks "5,10"

      - name: Run rank backtests + analysis
        run: |
          bash scripts/run_rank_backtests.sh

      - name: Run asset allocation backtests + analysis
        run: |
          bash scripts/run_aa_backtests.sh
          python scripts/analyze_aa_summary.py

      - name: Build combined email body (HTML)
        shell: bash
        run: |
          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          python scripts/build_daily_combined_email.py --date "${TODAY_KST}"

      - name: Send email (optional; requires SMTP_* + MAIL_*)
        shell: bash
        env:
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USER: ${{ vars.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_STARTTLS: ${{ vars.SMTP_STARTTLS }}
          MAIL_FROM: ${{ vars.MAIL_FROM }}
          MAIL_TO: ${{ vars.MAIL_TO }}
        run: |
          if [[ -z "${SMTP_HOST}" || -z "${MAIL_FROM}" || -z "${MAIL_TO}" || -z "${SMTP_PASS}" ]]; then
            echo "SMTP vars/secrets not configured; skipping send."
            exit 0
          fi
          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          SUBJECT="[Daily] Reports (${TODAY_KST} 08:00 KST)"
          python scripts/send_email_smtp.py \
            --subject "${SUBJECT}" \
            --html ".output/daily_reports/${TODAY_KST}/email.html" \
            --attach ".output/rank_summary.csv" \
            --attach ".output/rank_analysis.html" \
            --attach ".output/asset_allocation/summary.csv" \
            --attach ".output/aa_analysis.html"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-output
          path: |
            .output/daily_reports
            .output/daily
            .output/daily_asset_allocation
            .output/rank_summary.csv
            .output/rank_summary.md
            .output/rank_analysis.html
            .output/asset_allocation
            .output/aa_analysis.html

