name: weekly-rank-backtest

on:
  workflow_dispatch: {}
  schedule:
    # Monday 08:10 KST = Sunday 23:10 UTC
    - cron: "10 23 * * 0"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      # Backtest grid (candidates)
      HEAD_LOOKBACKS_CSV: "60,120,250"
      TAIL_LOOKBACKS_CSV: "10,20,40"
      TOPS_CSV: "50"
      REBAL_MONTHS_CSV: "1,3,6"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache price data
        uses: actions/cache@v4
        with:
          path: .cache
          key: price-cache-${{ runner.os }}-${{ hashFiles('requirements-actions.txt') }}
          restore-keys: |
            price-cache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-actions.txt

      - name: Run rank backtests (grid) + aggregate
        run: |
          bash scripts/run_rank_backtests.sh

      - name: Build weekly email body (HTML)
        run: |
          python scripts/build_weekly_rank_email.py \
            --summary-csv ".output/rank_summary.csv" \
            --out ".output/weekly_rank_email.html" \
            --top-n 10

      - name: Send email (optional; requires SMTP_* + MAIL_*)
        shell: bash
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_STARTTLS: ${{ secrets.SMTP_STARTTLS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
        run: |
          if [[ -z "${SMTP_HOST}" || -z "${MAIL_FROM}" || -z "${MAIL_TO}" ]]; then
            echo "SMTP secrets not configured; skipping send."
            exit 0
          fi
          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          SUBJECT="[Rank] Weekly Backtest Summary (${TODAY_KST})"
          python scripts/send_email_smtp.py \
            --subject "${SUBJECT}" \
            --html ".output/weekly_rank_email.html" \
            --attach ".output/rank_summary.csv" \
            --attach ".output/rank_summary.md" \
            --attach ".output/rank_analysis.html"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-rank-backtest-output
          path: |
            .output/rank_summary.csv
            .output/rank_summary.md
            .output/rank_analysis.html
            .output/weekly_rank_email.html
