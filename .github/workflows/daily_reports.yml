name: daily-reports

on:
  workflow_dispatch:
    inputs:
      send_email:
        description: "이메일 전송 여부 (기본: vars.SEND_EMAIL_ENABLED 또는 true)"
        required: false
        default: true
        type: boolean
      mail_to:
        description: "이메일 수신자 (비워두면 vars.MAIL_TO 사용)"
        required: false
        default: ""
        type: string
  schedule:
    # 매주 일요일 18:00 KST (GitHub Actions cron은 UTC 기준)
    # 18:00 KST = 09:00 UTC
    - cron: "0 9 * * 0"

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.weekcheck.outputs.run }}
      send_email: ${{ steps.toggles.outputs.send_email }}
      mail_to: ${{ steps.toggles.outputs.mail_to }}
    steps:
      - name: Gate scheduled/manual run
        id: weekcheck
        shell: bash
        run: |
          # Scheduled weekly run (no odd/even week gating). Manual runs always allowed.
          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Resolve email toggles
        id: toggles
        shell: bash
        run: |
          send_input="${{ inputs.send_email }}"
          default_send="${{ vars.SEND_EMAIL_ENABLED }}"
          if [[ -z "${default_send}" ]]; then
            default_send="true"
          fi
          if [[ -z "${send_input}" ]]; then
            send_email="${default_send}"
          else
            send_email="${send_input}"
          fi

          mail_input="${{ inputs.mail_to }}"
          mail_default="${{ vars.MAIL_TO }}"
          if [[ -z "${mail_input}" ]]; then
            mail_to="${mail_default}"
          else
            mail_to="${mail_input}"
          fi

          echo "send_email=${send_email}" >> "$GITHUB_OUTPUT"
          echo "mail_to=${mail_to}" >> "$GITHUB_OUTPUT"

  generate:
    needs: gate
    if: needs.gate.outputs.run == 'true'
    runs-on: ubuntu-latest
    env:
      SMTP_HOST: ${{ vars.SMTP_HOST }}
      SMTP_PORT: ${{ vars.SMTP_PORT }}
      SMTP_USER: ${{ vars.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_STARTTLS: ${{ vars.SMTP_STARTTLS }}
      MAIL_FROM: ${{ vars.MAIL_FROM }}
      MAIL_TO: ${{ needs.gate.outputs.mail_to }}
      SEND_EMAIL: ${{ needs.gate.outputs.send_email }}
      PYTHONPATH: ${{ github.workspace }}
      # Backtest parameters (reduced set for daily runs)
      HEAD_LOOKBACKS_CSV: "250,120,60"
      TAIL_LOOKBACKS_CSV: "40,20,10"
      TOPS_CSV: "50"
      REBAL_MONTHS_CSV: "1,3,6"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set report context (KST)
        id: report_ctx
        shell: bash
        run: |
          REPORT_ASOF_KST="$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')"
          REPORT_DATE_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          echo "report_date=${REPORT_DATE_KST}" >> "$GITHUB_OUTPUT"
          echo "report_asof=${REPORT_ASOF_KST}" >> "$GITHUB_OUTPUT"

      - name: Cache price data
        uses: actions/cache@v4
        with:
          path: .cache
          key: price-cache-${{ runner.os }}-${{ hashFiles('requirements-actions.txt') }}
          restore-keys: |
            price-cache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-actions.txt

      - name: Generate daily signals + email bodies
        run: |
          python scripts/daily_asset_allocation_report.py --asof-kst "${{ steps.report_ctx.outputs.report_asof }}"
          python scripts/daily_rank_report.py \
            --top 20 \
            --head-lookbacks "120,252" \
            --tail-lookbacks "20,40" \
            --asof-kst "${{ steps.report_ctx.outputs.report_asof }}"

      - name: Run rank backtests + analysis
        run: |
          bash scripts/run_rank_backtests.sh

      - name: Run asset allocation backtests + analysis
        run: |
          bash scripts/run_aa_backtests.sh
          python scripts/analyze_aa_summary.py

      - name: Build combined email body (HTML)
        shell: bash
        run: |
          python scripts/build_daily_combined_email.py --date "${{ steps.report_ctx.outputs.report_date }}"

      - name: Email disabled
        if: env.SEND_EMAIL != 'true'
        run: echo "Email sending disabled (SEND_EMAIL=${SEND_EMAIL}); skipping send job."

      - name: Send email (success or failure)
        if: env.SEND_EMAIL == 'true' && always()
        shell: bash
        run: |
          MAIL_TO_RESOLVED="${MAIL_TO:-}"
          if [[ -z "${SMTP_HOST}" || -z "${MAIL_FROM}" || -z "${MAIL_TO_RESOLVED}" || -z "${SMTP_PASS}" ]]; then
            echo "SMTP vars/secrets not configured; skipping send."
            exit 0
          fi

          JOB_STATUS="${{ job.status }}"
          REPORT_DATE_KST="${{ steps.report_ctx.outputs.report_date }}"
          if [[ -z "${REPORT_DATE_KST}" ]]; then
            REPORT_DATE_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          fi
          EMAIL_HTML=".output/daily_reports/${REPORT_DATE_KST}/email.html"

          if [[ "${JOB_STATUS}" == "success" && -f "${EMAIL_HTML}" ]]; then
            SUBJECT="[Daily] Reports (${REPORT_DATE_KST} 18:00 KST)"
            python scripts/send_email_smtp.py \
              --subject "${SUBJECT}" \
              --html "${EMAIL_HTML}" \
              --to "${MAIL_TO_RESOLVED}" \
              --attach ".output/rank_analysis.html" \
              --attach ".output/aa_analysis.html"
            exit 0
          fi

          mkdir -p .output
          FAIL_HTML=".output/daily_reports_failure_${REPORT_DATE_KST}.html"
          cat > "${FAIL_HTML}" <<HTML
          <html>
            <body>
              <h2>Daily report generation failed</h2>
              <p>The scheduled report for ${REPORT_DATE_KST} (KST) did not complete successfully.</p>
              <p>Please contact the administrator to investigate the workflow run.</p>
            </body>
          </html>
          HTML

          SUBJECT="[Daily] Reports FAILED (${REPORT_DATE_KST} 18:00 KST)"
          python scripts/send_email_smtp.py \
            --subject "${SUBJECT}" \
            --html "${FAIL_HTML}" \
            --to "${MAIL_TO_RESOLVED}"

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-output
          path: |
            .output/daily_reports
            .output/daily
            .output/daily_asset_allocation
            .output/rank_summary.csv
            .output/rank_summary.md
            .output/rank_analysis.html
            .output/asset_allocation
            .output/aa_analysis.html
