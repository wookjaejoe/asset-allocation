name: daily-reports

on:
  workflow_dispatch:
    inputs:
      send_email:
        description: "이메일 전송 여부 (기본: vars.SEND_EMAIL_ENABLED 또는 true)"
        required: false
        default: true
        type: boolean
      mail_to:
        description: "이메일 수신자 (비워두면 vars.MAIL_TO 사용)"
        required: false
        default: ""
        type: string
  schedule:
    # 원래 스케줄: 07:00 KST = 22:00 UTC (이전 일) 일요일
    # - cron: "0 22 * * 0"
    # 테스트용: 매 시 정각(UTC)마다 실행
    - cron: "0 * * * *"

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.weekcheck.outputs.run }}
      send_email: ${{ steps.toggles.outputs.send_email }}
      mail_to: ${{ steps.toggles.outputs.mail_to }}
    steps:
      - name: Check odd week (KST) or manual run
        id: weekcheck
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          WEEK="$(TZ=Asia/Seoul date +%V)"
          if ((10#$WEEK % 2 == 1)); then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve email toggles
        id: toggles
        shell: bash
        run: |
          send_input="${{ inputs.send_email }}"
          default_send="${{ vars.SEND_EMAIL_ENABLED }}"
          if [[ -z "${default_send}" ]]; then
            default_send="true"
          fi
          if [[ -z "${send_input}" ]]; then
            send_email="${default_send}"
          else
            send_email="${send_input}"
          fi

          mail_input="${{ inputs.mail_to }}"
          mail_default="${{ vars.MAIL_TO }}"
          if [[ -z "${mail_input}" ]]; then
            mail_to="${mail_default}"
          else
            mail_to="${mail_input}"
          fi

          echo "send_email=${send_email}" >> "$GITHUB_OUTPUT"
          echo "mail_to=${mail_to}" >> "$GITHUB_OUTPUT"

  generate:
    needs: gate
    if: needs.gate.outputs.run == 'true'
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      # Backtest parameters (reduced set for daily runs)
      HEAD_LOOKBACKS_CSV: "250,120,60"
      TAIL_LOOKBACKS_CSV: "40,20,10"
      TOPS_CSV: "50"
      REBAL_MONTHS_CSV: "1,3,6"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache price data
        uses: actions/cache@v4
        with:
          path: .cache
          key: price-cache-${{ runner.os }}-${{ hashFiles('requirements-actions.txt') }}
          restore-keys: |
            price-cache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-actions.txt

      - name: Generate daily signals + email bodies
        run: |
          python scripts/daily_asset_allocation_report.py
          python scripts/daily_rank_report.py \
            --top 20 \
            --head-lookbacks "120,252" \
            --tail-lookbacks "20,40"

      - name: Run rank backtests + analysis
        run: |
          bash scripts/run_rank_backtests.sh

      - name: Run asset allocation backtests + analysis
        run: |
          bash scripts/run_aa_backtests.sh
          python scripts/analyze_aa_summary.py

      - name: Build combined email body (HTML)
        shell: bash
        run: |
          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          python scripts/build_daily_combined_email.py --date "${TODAY_KST}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-output
          path: |
            .output/daily_reports
            .output/daily
            .output/daily_asset_allocation
            .output/rank_summary.csv
            .output/rank_summary.md
            .output/rank_analysis.html
            .output/asset_allocation
            .output/aa_analysis.html

  send:
    needs: [gate, generate]
    # always() lets the send job run even if generate failed, but gate still controls schedule/manual gating.
    if: needs.gate.outputs.run == 'true' && always()
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    env:
      SMTP_HOST: ${{ vars.SMTP_HOST }}
      SMTP_PORT: ${{ vars.SMTP_PORT }}
      SMTP_USER: ${{ vars.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_STARTTLS: ${{ vars.SMTP_STARTTLS }}
      MAIL_FROM: ${{ vars.MAIL_FROM }}
      MAIL_TO: ${{ needs.gate.outputs.mail_to }}
      SEND_EMAIL: ${{ needs.gate.outputs.send_email }}
      GENERATE_RESULT: ${{ needs.generate.result }}
    steps:
      - name: Email disabled
        if: env.SEND_EMAIL != 'true'
        run: echo "Email sending disabled (SEND_EMAIL=${SEND_EMAIL}); skipping send job."

      - uses: actions/checkout@v4
        if: env.SEND_EMAIL == 'true'

      - uses: actions/setup-python@v5
        if: env.SEND_EMAIL == 'true'
        with:
          python-version: "3.11"

      - name: Download latest artifacts from this run
        if: env.SEND_EMAIL == 'true' && needs.generate.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: daily-reports-output
          path: .

      - name: Send email (success or failure)
        if: env.SEND_EMAIL == 'true'
        shell: bash
        run: |
          MAIL_TO_RESOLVED="${MAIL_TO:-}"
          if [[ -z "${SMTP_HOST}" || -z "${MAIL_FROM}" || -z "${MAIL_TO_RESOLVED}" || -z "${SMTP_PASS}" ]]; then
            echo "SMTP vars/secrets not configured; skipping send."
            exit 0
          fi

          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          EMAIL_HTML=".output/daily_reports/${TODAY_KST}/email.html"

          if [[ "${GENERATE_RESULT}" == "success" && -f "${EMAIL_HTML}" ]]; then
            SUBJECT="[Daily] Reports (${TODAY_KST} 08:00 KST)"
            python scripts/send_email_smtp.py \
              --subject "${SUBJECT}" \
              --html "${EMAIL_HTML}" \
              --to "${MAIL_TO_RESOLVED}" \
              --attach ".output/rank_analysis.html" \
              --attach ".output/aa_analysis.html"
            exit 0
          fi

          mkdir -p .output
          FAIL_HTML=".output/daily_reports_failure_${TODAY_KST}.html"
          cat > "${FAIL_HTML}" <<HTML
          <html>
            <body>
              <h2>Daily report generation failed</h2>
              <p>The scheduled report for ${TODAY_KST} (KST) did not complete successfully.</p>
              <p>Please contact the administrator to investigate the workflow run.</p>
            </body>
          </html>
          HTML

          SUBJECT="[Daily] Reports FAILED (${TODAY_KST} 08:00 KST)"
          python scripts/send_email_smtp.py \
            --subject "${SUBJECT}" \
            --html "${FAIL_HTML}" \
            --to "${MAIL_TO_RESOLVED}"
