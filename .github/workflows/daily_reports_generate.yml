name: daily-reports-generate

on:
  workflow_dispatch:
  schedule:
    # 07:00 KST = 22:00 UTC (previous day)
    - cron: "0 22 * * 0"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      # Backtest parameters (reduced set for daily runs)
      HEAD_LOOKBACKS_CSV: "250,120,60"
      TAIL_LOOKBACKS_CSV: "40,20,10"
      TOPS_CSV: "50"
      REBAL_MONTHS_CSV: "1,3,6"
    steps:
      - name: Check odd week (KST) or manual run
        id: weekcheck
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          WEEK="$(TZ=Asia/Seoul date +%V)"
          if ((10#$WEEK % 2 == 1)); then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.weekcheck.outputs.run == 'true'

      - uses: actions/setup-python@v5
        if: steps.weekcheck.outputs.run == 'true'
        with:
          python-version: "3.11"

      - name: Cache price data
        if: steps.weekcheck.outputs.run == 'true'
        uses: actions/cache@v4
        with:
          path: .cache
          key: price-cache-${{ runner.os }}-${{ hashFiles('requirements-actions.txt') }}
          restore-keys: |
            price-cache-${{ runner.os }}-

      - name: Install dependencies
        if: steps.weekcheck.outputs.run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-actions.txt

      - name: Generate daily signals + email bodies
        if: steps.weekcheck.outputs.run == 'true'
        run: |
          python scripts/daily_asset_allocation_report.py
          python scripts/daily_rank_report.py \
            --top 20 \
            --head-lookbacks "120,252" \
            --tail-lookbacks "20,40"

      - name: Run rank backtests + analysis
        if: steps.weekcheck.outputs.run == 'true'
        run: |
          bash scripts/run_rank_backtests.sh

      - name: Run asset allocation backtests + analysis
        if: steps.weekcheck.outputs.run == 'true'
        run: |
          bash scripts/run_aa_backtests.sh
          python scripts/analyze_aa_summary.py

      - name: Build combined email body (HTML)
        if: steps.weekcheck.outputs.run == 'true'
        shell: bash
        run: |
          TODAY_KST="$(TZ=Asia/Seoul date +%Y%m%d)"
          python scripts/build_daily_combined_email.py --date "${TODAY_KST}"

      - name: Upload artifacts
        if: steps.weekcheck.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-output
          path: |
            .output/daily_reports
            .output/daily
            .output/daily_asset_allocation
            .output/rank_summary.csv
            .output/rank_summary.md
            .output/rank_analysis.html
            .output/asset_allocation
            .output/aa_analysis.html
