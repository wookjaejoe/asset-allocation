# 리밸런스 랭킹 백테스트 안내

## 전략이 하는 일
- **대상**: S&P 500 편입 종목. 리밸런스 시점의 실제 편입 종목만 사용합니다.
- **랭킹 기준**: 직전 `lookback` 거래일 누적 수익률을 계산해 순위 매깁니다.
  - `mode=head`: 상승률 상위 종목에 동일 비중 투자(모멘텀).
  - `mode=tail`: 하락률 하위 종목에 동일 비중 투자(리버전/저가 반등 기대).
- **편입 종목 수**: 상위/하위에서 `top`개를 뽑아 모두 똑같은 비중으로 담습니다.
- **리밸런스 주기**: 기본 1개월, 3개월·6개월 간격도 선택 가능합니다.
- **비교 기준(벤치마크)**: 같은 기간 유니버스 전체를 동일 비중으로 묶은 “시장 평균” 수익률과 비교합니다.
- **위험 필터**: 일일 수익률이 너무 큰(설정값 `max_daily_change`, 기본 ±100%) 종목은 해당 기간에서 제외합니다.

## 어떻게 계산되는지 (흐름만 간단히)
1) 리밸런스할 날짜(월말/3개월/6개월 간격)를 정합니다.
2) 각 날짜 직전에 `lookback` 기간 수익률을 계산해 순위를 매기고 `top`개를 고릅니다.
3) 다음 리밸런스까지 보유하며, 매일의 수익률을 더해 구간 수익률을 계산합니다.
4) 같은 구간에 유니버스 전체를 동일 비중으로 가정해 “시장 평균” 수익률도 계산합니다.
5) 매 구간의 포트폴리오 수익률, 벤치마크 수익률, 둘의 차이(초과수익)를 기록하고, 모든 구간을 이어 붙여 일별/월별 결과를 만듭니다.

## 결과 파일(.output 폴더)
각 조합은 `.output/rank_<mode>_lk<lookback>_top<top>_rbm<리밸런스개월>/` 폴더에 저장됩니다.
- `rank_backtest.csv`: 일별 포트폴리오 수익률(그래프, 변동성, 낙폭 계산에 사용).
- `rank_monthly.csv`: 리밸런스 구간별 요약(파일명은 기존 관례). 기간, 보유 종목·매수/매도 가격, `return`(포트), `benchmark_return`(시장 평균), `active_return`(초과 수익)이 포함됩니다.
- `rank_report.html`: 요약 리포트(수익률·변동성·낙폭 등 지표와 차트). 브라우저로 열면 됩니다.
- 여러 조합을 한 번에 돌린 후에는 `.output/rank_summary.csv`와 `.output/rank_summary.md`가 생겨, 모든 조합의 주요 지표(CAGR, 변동성, 최대낙폭, 주기별 초과수익 등)를 한눈에 비교할 수 있습니다.

## 결과 읽는 법
- `return`: 해당 리밸런스 구간(1/3/6개월) 포트 수익률.
- `benchmark_return`: 같은 기간 S&P500 유니버스 전체를 균등 비중으로 잡았을 때 수익률(시장 평균).
- `active_return = return - benchmark_return`: 초과 수익. 양수면 시장보다 나음.
- `rank_summary.csv`의 대표 지표:
  - `CAGR`: 연복리 수익률(장기 성과).
  - `ann_vol`: 연환산 변동성(일별 수익률 기준 흔들림).
  - `max_drawdown`: 최대 낙폭(얼마나 크게 빠질 수 있었는지).
  - `monthly_active_mean`: 리밸런스 주기별 초과 수익 평균(지속적으로 시장을 이겼는지).
해석 시 수익률만 보지 말고 변동성·낙폭도 함께 비교하세요. 리밸런스 주기가 다르면 표준편차(변동성) 비교가 공정하지 않을 수 있으니 같은 주기끼리 보거나 기간 보정된 지표를 참고하세요.

## 리스크와 한계
- **거래비용/세금/슬리피지 미반영**: 백테스트는 이 비용을 고려하지 않습니다. 실전 수익은 더 낮을 수 있습니다.
- **데이터 품질**: 야후 파이낸스 종가를 사용합니다. 지연·수정·결측 가능성이 있습니다.
- **구성 종목 변화**: 과거 시점의 실제 S&P 500 편입 종목을 사용하므로, 현재 지수와 다를 수 있습니다.
- **극단 변동 필터**: `max_daily_change`를 넘는 종목은 제외되어 편입 종목 수가 줄 수 있으며, 그만큼 분산 효과가 떨어질 수 있습니다.
- **동일 비중**: 종목마다 같은 비중으로 담습니다. 시가총액 가중이나 위험 조정 비중은 적용하지 않습니다.

## 도움말
- 리포트는 HTML 파일을 더블클릭해 브라우저로 열면 됩니다.
- CSV는 엑셀·스프레드시트로 열어도 됩니다.

## `rank_summary.csv` 주요 컬럼 설명
- `label`: 실행 조합 이름(예: rank_head_lk60_top20_rbm3).
- `mode`: head(상승 상위 매수) / tail(하락 하위 매수).
- `lookback`: 순위를 매길 때 참고한 거래일 수.
- `lookback_short` / `lookback_mid`: 혼합 전략에서 사용하는 단기/중기 창(해당될 때만 값이 채워짐).
- `top`: 한 번에 담는 종목 수(모두 동일 비중).
- `rebalance_months`: 리밸런스 간격(1=매월, 3=분기, 6=반기).
- `weight_mom` / `weight_rev`: 혼합 전략에서 모멘텀/리버설 스코어 가중치(해당될 때만 값이 채워짐).
- `daily_path` / `monthly_path`: 생성된 상세 CSV 파일 경로.
- `daily_start` / `daily_end`: 일별 수익률 시작/종료 날짜.
- `days`: 일별 수익률 데이터 포인트 수.
- `cagr`: 연복리 수익률(장기 성과).
- `ann_vol`: 연환산 변동성(수익률의 흔들림 정도).
- `max_drawdown`: 최대 낙폭(최고점 대비 얼마나 크게 빠졌는지).
- `months`: 리밸런스 구간 개수(월·분기·반기).
- `period_return_mean`: 리밸런스 구간(선택한 주기) 포트 수익률 평균.
- `period_benchmark_mean`: 같은 구간 유니버스 균등가중 벤치마크 수익률 평균.
- `period_spy_mean`: 같은 구간 SPY 수익률 평균.
- `period_active_mean`: 유니버스 벤치마크 대비 초과 수익 평균(`return - benchmark_return`).
- `period_active_spy_mean`: SPY 대비 초과 수익 평균(`return - spy_return`).
- `period_benchmark_cagr`: 유니버스 벤치마크 연복리 수익률(구간 수익률을 누적 후 전체 기간 기준).
- `period_spy_cagr`: SPY 연복리 수익률(구간 수익률을 누적 후 전체 기간 기준).
- `last_period_return`: 마지막 리밸런스 구간 포트 수익률.
- `last_period_benchmark_return`: 마지막 리밸런스 구간 유니버스 벤치마크 수익률.
- `last_period_spy_return`: 마지막 리밸런스 구간 SPY 수익률.
- `last_period_active_return`: 마지막 구간 유니버스 대비 초과 수익.
- `last_period_active_spy_return`: 마지막 구간 SPY 대비 초과 수익.

## `rank_report.html`(요약 리포트) 안내
TODO
